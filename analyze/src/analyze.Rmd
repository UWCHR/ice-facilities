---
title: "ICE analysis"
author: "Thiago Marques, Phil Neff"
date: "7/21/2020"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(here)
library(tidyverse)
library(lubridate)
library(skimr)
library(ggrepel)
library(broom)
library(margins)

```

```{r data_import, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

df_facilities <- read_delim(
  here('analyze', 'input', 'facil-list.csv.gz'), 
  delim = "|") 

df_dmcp <- read_delim(
  here('analyze', 'input', 'dmcp-detailed.csv.gz'),
  delim = "|")
          
df_encounters <- read_delim(
  here('analyze', 'input', 'encounters.csv.gz'), 
  delim = "|")
    
df_arrests <- read_delim(
  here('analyze', 'input', 'arrests.csv.gz'),
  delim = "|")
  
df_removals <- read_delim(
  here('analyze', 'input', 'removals.csv.gz'),
  delim = "|")

# This should be in input or frozen instead depending on where AOR-county task ultimately lives
aor_counties <- read_delim(
  here('analyze', 'output', 'county_aor.csv'),
  delim = ',')

```

```{r facil_data_setup_and_filter, message=FALSE, warning=FALSE}

# Dropping ORR facilities
# df_facilities <- df_facilities %>% 
  # filter(type != "ORR")

df_dmcp <- df_dmcp %>%
  mutate(state = as.factor(state))

df_dmcp <- df_dmcp %>%
  mutate(aor = as.factor(aor))

df_dmcp$over_under_72 <- as.factor(df_dmcp$over_under_72)

df_dmcp <- df_dmcp %>% 
  filter(over_under_72 == "Over 72")

df_dmcp_as_needed <- df_dmcp %>% 
  filter(capacity == "AS NEEDED")

df_facilities <- df_facilities %>% 
  filter(detloc %in% df_dmcp$detloc)

df_facilities %>% 
  filter(detloc %in% df_dmcp_as_needed$detloc ) %>% 
  summary()

# Testing that no other facilties are redacted
stopifnot(sum(df_facilities$detloc == 'Redacted') == 0)

# Concatenate facility city and state columns
df_facilities <- df_facilities %>% 
  unite("city", c(city,state), sep = ", ", remove = FALSE, na.rm = FALSE) %>%
  mutate(city = as.factor(city))

# There's probably a nicer way to convert various fields to factor
# Ideally specify field type on import
df_facilities <- df_facilities %>%
  mutate(detloc = as.factor(detloc))

df_facilities <- df_facilities %>%
  mutate(state = as.factor(state))

df_facilities <- df_facilities %>%
  mutate(city = as.factor(city))

df_facilities <- df_facilities %>%
  mutate(zip = as.factor(zip))

df_facilities <- df_facilities %>%
  mutate(aor = as.factor(aor))

df_facilities <- df_facilities %>%
  mutate(type = as.factor(type))

```


```{r enforcement_data_setup}

# This could be moved into a loop

# ARRESTS

df_arrests <- df_arrests %>% 
  filter(!is.na(aor))

df_arrests <- df_arrests %>% 
  separate(apprehension_date, 
           into = c(
             "apprehension_month", 
             "apprehension_day", 
             "apprehension_year"))

df_arrests <- df_arrests %>% 
  mutate(date = as.Date(paste(df_arrests$apprehension_year,
                              df_arrests$apprehension_month,
                              df_arrests$apprehension_day, sep = "-")))

# Converting date to quarter and fiscal year
df_arrests$apprehension_quarter <- 
  quarter(df_arrests$date, with_year = TRUE, fiscal_start = 10)
df_arrests$apprehension_fy <- stringr::str_sub(df_arrests$apprehension_quarter, 1, 4)
df_arrests$apprehension_fy <- as.integer(df_arrests$apprehension_fy)

# ENCOUNTERS

df_encounters <- df_encounters %>% 
  filter(!is.na(aor))

df_encounters <- df_encounters %>% 
  separate(event_date, 
           into = c(
             "event_month", 
             "event_day", 
             "event_year"))

df_encounters <- df_encounters %>% 
  mutate(date = as.Date(paste(df_encounters$event_year,
                              df_encounters$event_month,
                              df_encounters$event_day, sep = "-")))

# Converting date to quarter and fiscal year
df_encounters$event_quarter <- 
  quarter(df_encounters$date, with_year = TRUE, fiscal_start = 10)
df_encounters$event_fy <- stringr::str_sub(df_encounters$event_quarter, 1, 4)
df_encounters$event_fy <- as.integer(df_encounters$event_fy)

# REMOVALS - REMOVAL DATE

df_removals <- df_removals %>% 
  filter(!is.na(aor))

df_removals <- df_removals %>% 
  separate(removal_date, 
           into = c(
             "removal_month", 
             "removal_day", 
             "removal_year"))

df_removals <- df_removals %>% 
  mutate(date = as.Date(paste(df_removals$removal_year,
                              df_removals$removal_month,
                              df_removals$removal_day, sep = "-")))

# Converting date to quarter and fiscal year
df_removals$removal_quarter <- 
  quarter(df_removals$date, with_year = TRUE, fiscal_start = 10)
df_removals$removal_fy <- stringr::str_sub(df_removals$removal_quarter, 1, 4)
df_removals$removal_fy <- as.integer(df_removals$removal_fy)

# REMOVALS - DEPARTED DATE
df_removals <- df_removals %>% 
  separate(departed_date, 
           into = c(
             "departed_month", 
             "departed_day", 
             "departed_year"))

df_removals <- df_removals %>% 
  mutate(date = as.Date(paste(df_removals$departed_year,
                              df_removals$departed_month,
                              df_removals$departed_day, sep = "-")))

# Converting date to quarter and fiscal year
df_removals$departed_quarter <- 
  quarter(df_removals$date, with_year = TRUE, fiscal_start = 10)
df_removals$departed_fy <- stringr::str_sub(df_removals$departed_quarter, 1, 4)
df_removals$departed_fy <- as.integer(df_removals$departed_fy)



```

```{r aggregate_arrests_to_aor, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# aggregate arrests to aor
df_aor_arrests <- df_arrests %>%
  group_by(aor, apprehension_fy) %>% 
  summarize(n_arrests = n()) %>%
  ungroup()

# plot arrests levels
  ggplot(df_aor_arrests) + 
    geom_histogram(mapping = aes(x = n_arrests))

# plot arrests by fiscal year across aor
ggplot(data = df_aor_arrests,
       aes(x = apprehension_fy, 
           y = n_arrests, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of Arrests") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
  labs(title="ICE Arrests per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")

# plot arrests by fiscal year across aor with facet wrap
ggplot(data = df_aor_arrests,
       aes(x = apprehension_fy, 
           y = n_arrests, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of Arrests") +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5)) +
  labs(title="ICE Arrests per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")
ggsave(here("analyze", "output", "arrests_facet.pdf"))

```

```{r aggregate_encounters_to_aor, echo=FALSE, results='show', warning=FALSE, message=FALSE, include=FALSE}
# aggregate encounters to aor
df_aor_encounters <- df_encounters %>%
  group_by(aor, event_fy) %>% 
  summarize(n_encounters = n()) %>%
  ungroup()

# plot encounters levels
  ggplot(df_aor_encounters) + 
    geom_histogram(mapping = aes(x = n_encounters))

# plot encounters by fiscal year across aor
ggplot(data = df_aor_encounters,
       aes(x = event_fy, 
           y = n_encounters, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of encounters") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
  labs(title="ICE encounters per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")

# plot encounters by fiscal year across aor with facet wrap
ggplot(data = df_aor_encounters,
       aes(x = event_fy, 
           y = n_encounters, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of encounters") +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5)) +
  labs(title="ICE encounters per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")
ggsave(here("analyze", "output", "encounters_facet.pdf"))

```

```{r aggregate_removals_to_aor, echo=FALSE, results='show', warning=FALSE, message=FALSE, include=FALSE}
# aggregate removals to aor
df_aor_removals <- df_removals %>%
  group_by(aor, removal_fy) %>% 
  summarize(n_removals = n()) %>%
  ungroup()

# plot removals levels
  ggplot(df_aor_removals) + 
    geom_histogram(mapping = aes(x = n_removals))

# plot removals by fiscal year across aor
ggplot(data = df_aor_removals,
       aes(x = removal_fy, 
           y = n_removals, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of removals") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
  labs(title="ICE removals per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")

# plot removals by fiscal year across aor with facet wrap
ggplot(data = df_aor_removals,
       aes(x = removal_fy, 
           y = n_removals, 
           group = aor, 
           color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Number of removals") +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5)) +
  labs(title="ICE removals per Fiscal Year by AOR", caption="*FY2019 data through Aug. 2019")
ggsave(here("analyze", "output", "removals_facet.pdf"))

```

```{r aggregate_adp_to_aor, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
# aggregate adp to aor
df_aor_adp <- df_facilities %>%
  group_by(aor) %>% 
  summarize_at(vars(ends_with("adp"), -contains("bookin")), sum) %>%
  ungroup() # 24 AORs

df_aor_adp_pivot <- df_aor_adp %>%
  pivot_longer(
    cols = starts_with("fy"),
    names_to = "fiscal_year",
    values_to = "adp",
    values_drop_na = TRUE
  )

df_aor_adp_pivot$fiscal_year <- df_aor_adp_pivot$fiscal_year %>% str_replace_all('[aA-zZ]', '')

df_aor_adp_pivot$fiscal_year <- paste('20', df_aor_adp_pivot$fiscal_year, sep='')

df_aor_adp_pivot$fiscal_year <- as.integer(df_aor_adp_pivot$fiscal_year) 

ggplot(data = df_aor_adp_pivot,
       aes(x = fiscal_year, y = adp, group = aor, color = aor)) + 
  geom_line() +
  xlab("Fiscal Year") +
  ylab("ADP") +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5)) +
  labs(title="AOR Total ADP per Fiscal Year", caption="*Over 72-hour authorized DMCP facilities only")
ggsave(here("analyze", "output", "adp_facet.pdf"))
```

```{r, adp_arrest_totals}

df_aor_adp_pivot %>% 
  group_by(fiscal_year) %>% 
  summarise(adp = sum(adp)) %>% 
  ggplot(aes(x = fiscal_year, y = adp)) + 
  geom_line()

df_aor_arrests %>% 
  group_by(apprehension_fy) %>% 
  summarise(n_arrests = sum(n_arrests)) %>% 
  ggplot(aes(x = apprehension_fy, y = n_arrests)) + 
  geom_line()
```

```{r join_df_aor_enforcement_long, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# create empty data frame
df_aor_enforcement_long <- data.frame(fy = integer(),
                 aor = character(), 
                 stringsAsFactors = FALSE)

# join aor-level encounters data
df_aor_enforcement_long <- df_aor_enforcement_long %>% 
  full_join(df_aor_encounters, 
            by = c("aor", 
                   c("fy" = "event_fy"))
            )
# join aor-level arrests data
df_aor_enforcement_long <- df_aor_enforcement_long %>% 
  full_join(df_aor_arrests, 
            by = c("aor", 
                   c("fy" = "apprehension_fy"))
            )
# join aor-level removals data
df_aor_enforcement_long <- df_aor_enforcement_long %>% 
  full_join(df_aor_removals, 
            by = c("aor", 
                   c("fy" = "removal_fy"))
            )

# recode NA values
# These are dropped for now
df_aor_enforcement_long <- df_aor_enforcement_long %>% 
  mutate(aor = replace_na(aor, "UNKNOWN"))
```

```{r join_df_aor_detention_enforcement_long, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# create empty data frame
df_aor_adp_enforcement_long <- data.frame(fy = integer(),
                 aor = character(), 
                 stringsAsFactors = FALSE)

# join adp and enforcement data
df_aor_adp_enforcement_long <- df_aor_adp_enforcement_long %>%
  full_join(df_aor_adp_pivot,
            by = c("aor", 
                   c("fy" = "fiscal_year"))
            )
df_aor_adp_enforcement_long <- df_aor_adp_enforcement_long %>%
  full_join(df_aor_enforcement_long,
            by = c("aor", "fy")
            ) %>%
    arrange(aor, fy, adp)


# convert to factor
df_aor_adp_enforcement_long <- df_aor_adp_enforcement_long %>%
  mutate(aor = as.factor(aor), 
         fy = as.factor(fy),
         )
```

```{r add_new_variables_change_1yr, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

df_aor_adp_enforcement_long[df_aor_adp_enforcement_long == 0] <- NA

# create one-fy change variables in average daily population and enforcement practices
df_aor_adp_enforcement_long <- df_aor_adp_enforcement_long %>% 
  group_by(aor) %>% 
   # levels
  mutate(
    diff_adp = adp - lag(adp),
    diff_n_encounters = n_encounters - lag(n_encounters), 
    diff_n_arrests = n_arrests - lag(n_arrests),
    diff_n_removals = n_removals - lag(n_removals),
    # percents
    pct_diff_adp = (diff_adp / lag(adp) * 100),
    pct_diff_encounters = (diff_n_encounters / lag(n_encounters) * 100),
    pct_diff_arrests = (diff_n_arrests / lag(n_arrests) * 100),
    pct_diff_removals = (diff_n_removals / lag(n_removals) * 100)
    ) %>%
  ungroup()

# plot percent change in adp by fy across aor
df_aor_adp_enforcement_long %>% 
  ggplot(aes(x = fy, y = pct_diff_adp, group = aor, color = aor)) + 
  geom_hline(yintercept=0, alpha=.33) +
  geom_line() +
  xlab("Fiscal Year") +
  ylab("Percent Change in Average Daily Population (ADP)") + 
  coord_cartesian(ylim = c(-150, 150)) +
  # ylim(-100, 100) +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5)) +
  labs(title="Percent Change in Average Daily Population (ADP), FY2010-FY2018",
       caption="*Over 72-hour authorized DMCP facilities only")
ggsave(here("analyze", "output", "adp_over_time.pdf"))

# plot percent change in encounters by fy across aor
df_aor_adp_enforcement_long %>% 
  filter(!is.na(pct_diff_encounters)) %>% 
  ggplot(aes(x = fy, y = pct_diff_encounters, group = aor, color = aor)) + 
  geom_hline(yintercept=0, alpha=.33) +  
  geom_line() +
  xlab("FY") +
  ylab("Percent Change in Encounters") + 
  ggtitle("Percent Change in Encounters, FY2016-FY2019") +
  theme_bw() + 
  facet_wrap(~ aor) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
ggsave(here("analyze", "output", "encounters_over_time.pdf"))

# plot percent change in arrests by year across aor
df_aor_adp_enforcement_long %>% 
  filter(!is.na(pct_diff_arrests)) %>% 
  ggplot(aes(x = fy, y = pct_diff_arrests, group = aor, color = aor)) + 
  geom_hline(yintercept=0, alpha=.33) +  
  geom_line() +
  xlab("FY") +
  ylab("Percent Change in Arrests") + 
  ggtitle("Percent Change in Arrests, FY2016-FY2019") +
  theme_bw() + 
  facet_wrap(~ aor) +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
ggsave(here("analyze", "output", "arrests_over_time.pdf"))

# plot percent change in removals by year across aor
df_aor_adp_enforcement_long %>%
  filter(!is.na(pct_diff_removals)) %>% 
  ggplot(aes(x = fy, y = pct_diff_removals, group = aor, color = aor)) + 
  geom_hline(yintercept=0, alpha=.33) +  
  geom_line() +
  xlab("FY") +
  ylab("Percent Change in Removals") + 
  ggtitle("Percent Change in Removals, FY2016-FY2019") +
  theme_bw() + 
  facet_wrap(~ aor) +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))
ggsave(here("analyze", "output", "removals_over_time.pdf"))

```

```{r }
df_aor_adp_enforcement_long_complete <- df_aor_adp_enforcement_long %>%
  filter(!is.na(adp),           # remove missing adp
         !is.na(n_encounters),  # remove missing encounters
         !is.na(n_arrests),     # remove missing arrests
         !is.na(n_removals))    # remove missing removals

df_aor_adp_change_complete <- df_aor_adp_enforcement_long %>% 
  select(c('fy', 'aor', starts_with('pct_diff'))) %>% 
  filter(!is.na(pct_diff_adp),
         !is.na(pct_diff_arrests),
         !is.na(pct_diff_encounters),
         !is.na(pct_diff_removals))

# skim summary statistics
df_aor_adp_enforcement_long_complete %>%
 select(adp, n_encounters, n_arrests, n_removals) %>%
 skim() # skewed right

df_aor_adp_change_complete %>% 
  ggplot(aes(x = pct_diff_adp, y = pct_diff_arrests, colour=aor)) +
  geom_point()

df_aor_adp_change_complete %>% 
  ggplot(aes(x = pct_diff_adp, y = pct_diff_encounters, colour=aor)) +
  geom_point()

df_aor_adp_change_complete %>% 
  ggplot(aes(x = pct_diff_adp, y = pct_diff_removals, colour=aor)) +
  geom_point()
```

```{r summarize_visualize_distributions_adp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# calculate summary statistics
  summary(df_aor_adp_enforcement_long_complete$adp)

# visualize distribution
  df_aor_adp_enforcement_long_complete %>% 
    ggplot(aes(adp)) +
    geom_density(fill="midnightblue")

   # visualize distributions for adp
      # plot density curve for adp
      ggplot(df_aor_adp_enforcement_long_complete, aes(x = adp)) + geom_density() # skewed right
      # plot density curve for log adp
      ggplot(df_aor_adp_enforcement_long_complete, aes(x = log(adp))) + geom_density() # lightly bimodal
  
      # plot histogram/bar graph for adp
        # count
        ggplot(df_aor_adp_enforcement_long_complete, aes(x=adp)) +
          geom_histogram(colour="black", fill="white")
        # count log transformation
        ggplot(df_aor_adp_enforcement_long_complete, aes(x=log(adp))) +
            geom_histogram(colour="black", fill="white")
```

```{r summarize_visualize_distributions_arrests, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# calculate summary statistics
  summary(df_aor_adp_enforcement_long_complete$n_arrests)
  
# visualize distributions for arrests
# plot density curve for arrests
ggplot(df_aor_adp_enforcement_long_complete, aes(x = n_arrests, label = aor)) + geom_density() # skewed right
# plot density curve for log arrests
ggplot(df_aor_adp_enforcement_long_complete, aes(x = log(n_arrests), label = aor)) + geom_density() # light bimodal

# plot histogram/bar graph for arrests
# count
ggplot(df_aor_adp_enforcement_long_complete, aes(x=n_arrests), label = aor) + 
  geom_histogram(colour="black", fill="white")
# count with larger bins
ggplot(df_aor_adp_enforcement_long_complete, aes(x=n_arrests), label = aor) + 
  geom_histogram(colour="black", fill="white", binwidth = 5000, na.rm = TRUE)
# count log transformation
ggplot(df_aor_adp_enforcement_long_complete, aes(x=log(n_arrests))) +
  geom_histogram(colour="black", fill="white")

```

The following test correlation between ADP and enforcement variables using various methods. How to decide whether log or linear methods better? However, in every case we see strongest correlation between ADP & removals, followed by arrests, encounters, as seen in the scatter plots. It is logical that AORs doing more deportations would have higher ADPs.

```{r estimate_correlation_adp_enforcement, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

# compute the pearson correlation coefficient
  # adp and arrests: linear-linear
  df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, n_arrests)) %>% pull(r)
    # (all facilities) 0.4776379 
    # (DMCP >72) 0.5177671 
  # adp and encounters: linear-linear
  df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, n_encounters)) %>% pull(r)
    # (all facilities) 0.2602638
    # (DMCP >72) 0.3105438
    # adp and removals: linear-linear
  df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, n_removals)) %>% pull(r)
    # (all facilities) 0.8566064
    # (DMCP >72) 0.7580026
  
      # cor(x = df_aor_adp_enforcement_long_complete$adp,
      #     y = df_aor_adp_enforcement_long_complete$n_arrests,
      #     method = 'pearson')


  # adp and arrests: log-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), log(n_arrests))) %>% pull(r)
    # (all facilities) 0.604332
    # (DMCP >72) 0.5538412
  # adp and encounters: log-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), log(n_encounters))) %>% pull(r)
    # (all facilities) 0.3823452
    # (DMCP >72) 0.3539863
  # adp and removals: log-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), log(n_removals))) %>% pull(r)
    # (all facilities) 0.8554676
    # (DMCP >72) 0.8059589
            

  # adp and arrests: linear-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, log(n_arrests))) %>% pull(r)
    # (all facilities) 0.5094287
    # (DMCP >72) 0.5419437
  # adp and encounters: linear-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, log(n_encounters))) %>% pull(r)
    # (all facilities) 0.2887579
    # (DMCP >72) 0.314883
  # adp and removals: linear-log
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(adp, log(n_removals))) %>% pull(r)
    # (all facilities) 0.7982713
    # (DMCP >72) 0.8176056
    
    
  # adp and arrests: log-linear
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), n_arrests)) %>% pull(r)
    # (all facilities) 0.541137
    # (DMCP >72) 
      # adp and encounters: log-linear
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), n_encounters)) %>% pull(r)
    # (all facilities) 0.3595946
    # (DMCP >72) 0.4996742
      # adp and removals: log-linear
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log(adp), n_removals)) %>% pull(r)
    # (all facilities) 0.7127637
    # (DMCP >72) 0.6345875
    
  # adp and arrests: log2-log2
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log2(adp), log2(n_arrests))) %>% pull(r)
    # (all facilities) 0.604332
    # (DMCP >72) 0.5538412
  # adp and encounters: log2-log2
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log2(adp), log2(n_encounters))) %>% pull(r)
    # (all facilities) 0.3823452
    # (DMCP >72) 0.3539863
  # adp and removals: log2-log2
    df_aor_adp_enforcement_long_complete %>% summarize(r = cor(log2(adp), log2(n_removals))) %>% pull(r)
    # (all facilities) 0.8554676
    # (DMCP >72) 0.8059589
    
df_aor_adp_enforcement_long_complete %>% 
  ggplot(aes(x = log(adp), y = log(n_removals), colour=aor)) +
  geom_point()
    
df_aor_adp_enforcement_long_complete %>% 
  ggplot(aes(x = log(adp), y = log(n_arrests), colour=aor)) +
  geom_point()

df_aor_adp_enforcement_long_complete %>% 
  ggplot(aes(x = log(adp), y = log(n_encounters), colour=aor)) +
  geom_point()
```

All correlations statistically significant: ADP-removals most significant, followd by ADP-arrests, ADP-encounters.

```{r cor_test_arrests_adp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

# adp and arrests
  cor.test(x = df_aor_adp_enforcement_long_complete$adp, 
           y = df_aor_adp_enforcement_long_complete$n_arrests, 
           alternative="two.sided", conf.level=0.95, method='pearson')
    # (all facilities) p-value = 2.209e-05
    # (DMCP >72) p-value = 3.197e-06

# log-log transformation
cor.test(x = (log(df_aor_adp_enforcement_long_complete$adp)), 
         y = (log(df_aor_adp_enforcement_long_complete$n_arrests)), 
         alternative="two.sided", conf.level=0.95, method='pearson') 
    # (all facilities) p-value = 1.899e-08
    # (DMCP >72) p-value = 4.499e-07


# adp and encounters
  cor.test(x = df_aor_adp_enforcement_long_complete$adp, 
           y = df_aor_adp_enforcement_long_complete$n_encounters, 
           alternative="two.sided", conf.level=0.95, method='pearson')
    # (all facilities) p-value = 0.02725
    # (DMCP >72) p-value = 0.007933

# log-log transformation
cor.test(x = (log(df_aor_adp_enforcement_long_complete$adp)), 
         y = (log(df_aor_adp_enforcement_long_complete$n_encounters)), 
         alternative="two.sided", conf.level=0.95, method='pearson') 
    # (all facilities) p-value = 0.0009183
    # (DMCP >72) p-value = 0.002284

# adp and removals
  cor.test(x = df_aor_adp_enforcement_long_complete$adp, 
           y = df_aor_adp_enforcement_long_complete$n_removals, 
           alternative="two.sided", conf.level=0.95, method='pearson')
    # (all facilities)  p-value < 2.2e-16

# log-log transformation
cor.test(x = (log(df_aor_adp_enforcement_long_complete$adp)), 
         y = (log(df_aor_adp_enforcement_long_complete$n_removals)), 
         alternative="two.sided", conf.level=0.95, method='pearson') 
    # (all facilities) p-value < 2.2e-16
    # (DMCP >72) p-value < 2.2e-16


# pct_diff

cor.test(x = (log(df_aor_adp_change_complete$pct_diff_adp)), 
         y = (log(df_aor_adp_change_complete$pct_diff_removals)), 
         alternative="two.sided", conf.level=0.95, method='pearson')
  # (all facilities) cor 0.6042734 
  # (all facilities) p-value = 0.0008436
  # (DMCP >72) cor 0.3779104 
  # (DMCP >72) p-value = 0.04325
cor.test(x = (log(df_aor_adp_change_complete$pct_diff_adp)), 
         y = (log(df_aor_adp_change_complete$pct_diff_arrests)), 
         alternative="two.sided", conf.level=0.95, method='pearson')
  # (all facilities) cor 0.3529618
  # (all facilities) p-value = 0.05572
  # (DMCP >72) cor 0.224196 
  # (DMCP >72) p-value = 0.2174

cor.test(x = (log(df_aor_adp_change_complete$pct_diff_adp)), 
         y = (log(df_aor_adp_change_complete$pct_diff_encounters)), 
         alternative="two.sided", conf.level=0.95, method='pearson')
  # (all facilities) cor -0.01120545 
  # (all facilities) p-value = 0.9626
  # (DMCP >72) cor -0.05257015 
  # (DMCP >72) p-value = 0.8117
```

```{r }
# https://b-rodrigues.github.io/modern_R/statistical-models.html#fitting-a-model-to-data

model1 <- lm(log(n_arrests) ~ log(adp), data = df_aor_adp_enforcement_long_complete)


summary(model1)
print(model1$coefficients)

results1 <- broom::tidy(model1)
glimpse(results1)
results1 %>%
  filter(p.value < 0.05)
results1 <- broom::tidy(model1, conf.int = TRUE, conf.level = 0.95)

print(results1)
broom::glance(model1)

# autoplot(model1, which = 1:6) + theme_minimal()

resi1 <- residuals(model1)
aor_aug <- augment(model1)
glimpse(aor_aug)
ggplot(aor_aug) +
  geom_density(aes(.resid))

fit1 <- fitted(model1)

total_pos <- aor_aug %>%
  filter(.resid > 0) %>%
  summarise(total = n()) %>%
  pull(total)

effects_model1 <- margins(model1)

summary(effects_model1)

plot(effects_model1)
effects_model1 <- summary(effects_model1)

ggplot(data = effects_model1) +
  geom_point(aes(factor, AME)) +
  geom_errorbar(aes(x = factor, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))


ggplot(df_aor_adp_enforcement_long_complete) +
  geom_density(aes(n_arrests))

model_log <- lm(log(n_arrests) ~ log(adp), data = df_aor_adp_enforcement_long_complete)

result_log <- broom::tidy(model_log)

print(result_log)

glance(model_log)
```

```{r}

df_aor_adp_monthly <- df_facilities %>%
  select(c(aor, november_2016), ends_with("_2017")) %>% 
  group_by(aor) %>% 
  summarize_at(vars(november_2016, ends_with("_2017")), sum) %>%
  ungroup() # 24 AORs

df_aor_adp_monthly <- df_aor_adp_monthly %>%
  pivot_longer(
    cols = c(november_2016, ends_with(("_2017"))),
    names_to = "month",
    values_to = "adp",
    values_drop_na = TRUE
  )

df_aor_adp_monthly <- df_aor_adp_monthly %>% 
  separate(month, c('month', 'year'), '_')

df_aor_adp_monthly$month <- Hmisc::capitalize(df_aor_adp_monthly$month)

df_aor_adp_monthly$month <- match(df_aor_adp_monthly$month, month.name)

df_aor_arrests_monthly <- df_arrests %>% 
  group_by(aor, apprehension_year, apprehension_month) %>% 
  summarize(n_arrests = n(), .groups="keep") %>%
  ungroup()

df_aor_arrests_monthly$apprehension_year <-
  as.integer(df_aor_arrests_monthly$apprehension_year)

df_aor_arrests_monthly$apprehension_month <-
  as.integer(df_aor_arrests_monthly$apprehension_month)

df_aor_adp_monthly$month <-
  as.integer(df_aor_adp_monthly$month)

df_aor_adp_monthly$year <-
  as.integer(df_aor_adp_monthly$year)

df_aor_adp_arrests_monthly <-
  full_join(df_aor_adp_monthly,
            df_aor_arrests_monthly,
            by=c('aor' = 'aor',
                 'year' = 'apprehension_year',
                 'month' = 'apprehension_month'))

df_aor_adp_arrests_monthly <- df_aor_adp_arrests_monthly %>% 
  filter(!is.na(adp),
         !is.na(n_arrests))

df_aor_adp_arrests_monthly %>% 
  ggplot(aes(x = adp, y = n_arrests, colour=aor)) +
  geom_point()

 df_aor_adp_arrests_monthly %>% summarize(r = cor(adp, n_arrests)) %>% pull(r)
 
 df_aor_adp_arrests_monthly <- df_aor_adp_arrests_monthly %>% 
  group_by(aor) %>% 
   # levels
  mutate(
    diff_adp = adp - lag(adp),
    # diff_n_encounters = n_encounters - lag(n_encounters), 
    diff_n_arrests = n_arrests - lag(n_arrests),
    # diff_n_removals = n_removals - lag(n_removals),
    # percents
    pct_diff_adp = (diff_adp / lag(adp) * 100),
    # pct_diff_encounters = (diff_n_encounters / lag(n_encounters) * 100),
    pct_diff_arrests = (diff_n_arrests / lag(n_arrests) * 100)
    # pct_diff_removals = (diff_n_removals / lag(n_removals) * 100)
    ) %>%
  ungroup()

df_aor_adp_arrests_monthly %>% 
  ggplot(aes(x = pct_diff_adp, y = pct_diff_arrests, colour=aor)) +
  geom_point() 

df_aor_adp_arrests_monthly %>% 
  filter(!is.na(pct_diff_adp),
         !is.na(pct_diff_arrests)) %>% 
  summarize(r = cor(pct_diff_adp, pct_diff_arrests)) %>% pull(r)

```

