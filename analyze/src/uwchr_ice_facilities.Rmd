---
title: "Exploratory Data Analysis (EDA) of Immigration and Customs Enforcement (ICE) Detention Facilities, 2016--2019"
subtitle: "Freedom of Information Act (FOIA) Request Records"
author: Thiago Marques
-institute: University of Washington Center for Human Rights
date: "January 6, 2020"
output:
  word_document: default
  pdf_document: default
---

# Introduction
Interior immigration enforcement is receiving increased attention from researchers in collaboration with activists and advocacy groups. The University of Washington Center for Human Rights answers the following research questions in partnership with local social movements. The research questions in this project describe and explain the following associations:

* 1. What is the influence of detention center capacity on immigration law enforcement practices? 
** a. What is the influence of average daily population (ADP) on:
***  i. encounters
***  ii. arrests
*** iii. removals
  
* 2. What is the influence of detention center capacity on immigration bail bonds?
**a. What is the influence of detention center capacity on:
***  i. money deposit
***  ii. cash bail

* The number of moves to opportunity neighborhoods made by families, particularly those with younger children, and;

* how long families stay in those neighborhoods.

This .Rmd file performs data wrangling tasks and exploratory analyses of administrative records on detention facilities spanning the years 2016--2019 obtained from Department of Homeland Security (DHS) Immigration and Customs Enforcement (ICE) via Freedom of Information Act (FOIA) requests submitted by the University of Washington Center for Human Rights.

U.S. Immigration and Customs Enforcement

I tidy these data to then facilitate their transformation and visualization. I describe univariate statistics and covariation between variables I observe for the purpose of modelling associations among immigration detention facilities, interior immigration law enforcement practices, and immigration bail bonds.

# Data wrangling
I first clear the working memory, load user-created packages, and import data with the `R` programming language and software environment for statistical computing and graphics. I tidy these data to then facilitate their transformation and visualization. 

## Import data and data management
```{r install_load_packages, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# clear memory
rm(list=ls())

# check current library paths
.libPaths() # [1] "C:/Users/marqu/Documents/R/win-library/3.6"
# [2] "C:/Program Files/R/R-3.6.2/library"

# install and load packages
library(pander) # creates tables
library(tidyverse) # easily install and load the 'Tidyverse' set of packages
library(tidycensus)
library(ipumsr)
library(shiny)
library(DT)
library(scales)
library(stringr)
library(lavaan)
library(forcats)
library(lubridate)
library(eeptools)
library(naniar)
library(VIM)
library(reshape2)
library(ggalt)
```

```{r read_data, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check working directory
getwd() # "C:/Users/marqu/Google Drive/thiagm@uw.edu 2018-12-22 02_24/Academic/Graduate School/University of Washington/Research/Projects/ICE"

# set working directory
setwd("C:/Users/marqu/Google Drive/thiagm@uw.edu 2018-12-22 02_24/Academic/Graduate School/University of Washington/Research/Projects/ICE")

# load rectangular data
  # read facilities data
  df <- ice_facilities_data <- read_delim(
    "C:/Users/marqu/git/ice-facilities/analyze/input/2019-ICFO-31121.csv.gz", 
                         delim = "|", 
                         skip = 6) # skip rows of metadata
  
  # read arrests data
  df.arrests <- ice_arrests_data <- read_csv(
    "C:/Users/marqu/git/ice-ero-lesa/us/import/input/EROArrests_LESA_STU_Final-REDACTED.csv", 
                       #  delim = "|", 
                         skip = 5) # skip rows of metadata

  #clean/output/facil-list.csv.gz 
    # check against other dataset
  

# view data frame
df
#View(df)

# rename columns
df <- df %>% 
  rename(Facility_Name = Name, 
         Facility_Street = Address, 
         Facility_City = City,
         Facility_State = State, 
         Facility_Zip = Zip,
         Facility_AOR = AOR, 
         Facility_Type = Type, 
         Authorization_Status = "Authorization Status", 
         Authorizing_Authority = "Authorizing Authority",
         FY19_ADP = "FY19 ADP", 
         FY18_ADP = "FY18 ADP", 
         FY17_ADP = "FY17 ADP", 
         FY16_ADP = "FY16 ADP", 
         FY15_ADP = "FY15 ADP", 
         FY14_ADP = "FY14 ADP", 
         FY13_ADP = "FY13 ADP", 
         FY12_ADP = "FY12 ADP", 
         FY11_ADP = "FY11 ADP", 
         FY19_ADP_Male_Crim = "Male Crim", 
         FY19_ADP_Male_NonCrim = "Male Non-Crim", 
         FY19_ADP_Female_Crim= "Female Crim", 
         FY19_ADP_Female_NonCrim = "Female Non-Crim", 
         FY19_InitialBookins = "FY19 Initial Bookins", 
         FY18_InitialBookins = "FY18 Initial Bookins", 
         FY17_InitialBookins = "FY17 Initial Bookins", 
         FY16_InitialBookins = "FY16 Initial Bookins", 
         FY15_InitialBookins = "FY15 Initial Bookins", 
         FY14_InitialBookins = "FY14 Initial Bookins", 
         FY13_InitialBookins = "FY13 Initial Bookins", 
         FY12_InitialBookins = "FY12 Initial Bookins", 
         FY11_InitialBookins = "FY11 Initial Bookins")

colnames(df)

# load (tidy)census decennial and inter-decennial rectangular data
#vt <- get_decennial(
#  geography,
#  year = 2010,
#  geometry = 
#
#
# = "county", 
#             variables = c(medincome = "B19013_001"), 
#             state = "VT",
# year =
```
This data frame contains all 214 detention facilities contracted to intern immigrant prisoners in the United States (US) from 2016--2019. The data come from Immigration and Customs Enforcement (ICE) within the Department of Homeland Security, and is  documented in SOURCE.

```{r structure, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check number of rows and columns
nrow(df)
ncol(df)

# check structure of data
str(df) # no factor variables
glimpse(df)

# check beginning and end of data
head(df[, c(6:7, 10)])
tail(df[, c(6:7, 10)])

# check variable names
names(df)

# standardize variable names
#names(df) <- tolower(names(df))
#names(df)

```

## Tidy data and data transformation
I will solve the vast majority of my data manipulation challenges in this section. Here, I will recode my variables of interest. It is important to note that I will be replacing the unusual values (i.e, not in universe, unknown) with missing values (i.e., NA in R).

### Select variables
#### Detention location
Detention facilities are uniquely identified by a code (`DETLOC`). Other geographic variables include facility name, street address, city, state, and ZIP code. Facilities are also located within an area of responsibility (AOR).

```{r DETLOC, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# DETLOC
# check levels
class(df$DETLOC)

df %>%
  count(DETLOC)

# verify unique IDs
df %>%
  count(DETLOC) %>%
  filter(n > 1) # rows are unique

# convert to factor
df <- df %>%
  mutate(DETLOC = as.factor(DETLOC))
```

#### Facility name
```{r Facility_Name, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_Name
# check levels
class(df$Facility_Name)
class(df$`Facility_Name`)
class(df$"Facility_Name")

df %>%
  count(Facility_Name)
df %>%
  count(`Facility_Name`)
df %>%
  count("Facility_Name")

# verify unique IDs
df %>%
  count(Facility_Name) %>%
  filter(n > 1)
    #BUTLER COUNTY JAIL	2			
    #ORANGE COUNTY JAIL	2	

df %>%
  summarise(count = n_distinct(Facility_Name)) # 212 unique facility names
```

#### Facility street address
```{r Facility_Street, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_Street
# check levels
class(df$Facility_Street)
class(df$`Facility_Street`)
class(df$"Facility_Street")

df %>%
  count(Facility_Street)
df %>%
  count(`Facility_Street`)
df %>%
  count("Facility_Street")

# verify unique IDs
df %>%
  count(Facility_Street) %>%
  filter(n > 1)

    #600 EAST FOURTH ST.	2			
    #FM 1144 AT US HIGHWAY 181	2

df %>%
  summarize(count = n_distinct(Facility_Street)) # 212 unique facility streets
```

#### Facility state
```{r Facility_State, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_State
# check levels
class(df$Facility_State)
class(df$`Facility_State`)
class(df$"Facility_State")

df %>%
  count(Facility_State) # 47 rows
df %>%
  count(`Facility_State`) # 47 rows
df %>%
  count("Facility_State") # 214 rows
table(df$Facility_State)

# plot levels
ggplot(df, aes(Facility_State)) + 
  geom_bar()  +
  theme(axis.text.x = element_text(angle = 90, size = 10))

# convert to factor
df <- df %>%
  mutate(Facility_State = as.factor(Facility_State))

# check proportions
table(df$Facility_State)
tab1 <- table(df$Facility_State)
prop.table(tab1)
df %>%
  count(Facility_State)
```

#### Facility city
```{r Facility_City, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_City
# check levels
class(df$Facility_City)
class(df$`Facility_City`)
class(df$"Facility_City")

df %>%
  count(Facility_City)
df %>%
  count(`Facility_City`)
df %>%
  count("Facility_City") # 198 rows

# verify unique obs
df %>%
  count(Facility_City) %>%
  filter(n > 1) # 16 duplicates

df %>%
  summarize(count = n_distinct(Facility_City)) # 198 unique cities

# concatenate facility city and state columns
df <- df %>% 
  unite("Facility_City", Facility_City:Facility_State, sep = ", ", remove = FALSE, na.rm = FALSE) %>%
  mutate(Facility_City = as.factor(Facility_City))

# plot levels
ggplot(df, aes(Facility_City)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 90, size = 10))
```

#### Facility ZIP code
```{r Facility_Zip, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_Zip
# check levels
class(df$Facility_Zip)
class(df$`Facility_Zip`)
class(df$"Facility_Zip")

df %>%
  count(Facility_Zip) # 200 rows
df %>%
  count(`Facility_Zip`) # 200 rows
df %>%
  count("Facility_Zip") # 214 rows

# verify unique obs
df %>%
  count(Facility_Zip) %>%
  filter(n > 1) # 13 rows

# plot levels
ggplot(df, aes(Facility_Zip)) + 
  geom_bar()

# check proportions
table(df$Facility_Zip)
tab1 <- table(df$Facility_Zip)
prop.table(tab1)
df %>%
  count(Facility_Zip)
```

#### Facility area of responsibility (AOR)
```{r Facility_AOR, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_AOR
# check levels
class(df$Facility_AOR)
class(df$`Facility_AOR`)
class(df$"Facility_AOR")

df %>%
  count(Facility_AOR) # 24 rows
df %>%
  count(`Facility_AOR`) # 24 rows
df %>%
  count("Facility_AOR") # 214 rows
table(df$Facility_AOR)

# plot levels
ggplot(df, aes(Facility_AOR)) + 
  geom_bar()  +
  theme(axis.text.x = element_text(angle = 90, size = 10))

# convert to factor
df <- df %>%
  mutate(Facility_AOR = as.factor(Facility_AOR))

# check proportions
table(df$Facility_AOR)
tab1 <- table(df$Facility_AOR)
prop.table(tab1)
df %>%
  count(Facility_AOR)
```

#### Facility type
```{r Facility_Type, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Facility_Type                   
# check levels
class(df$Facility_Type)
class(df$`Facility_Type`)
class(df$"Facility_Type")

df %>%
  count(Facility_Type) # 4 rows
df %>%
  count(`Facility_Type`) # 4 rows
df %>%
  count("Facility_Type") # 214 rows

#1 CDF              13 Contract Detention Facility (CDF). A detention facility owned and operated by a private company in the business of providing detention services under a government contract. Like the SPCs the CDFs are one of several types of facilities used by ICE to house detained individuals.

#2 IGSA            112 Intergovernmental Service Agreement (IGSA) Facility. IGSAs are agreements between the federal government and a state or local government to provide detention beds in jails, prisons, and other local or state government detention facilities. While government owned, these facilities may be operated by either local or state agencies or by a private company in the business of providing detention services. Some of these facilities may even be dedicated for federal use.

#3 SPC               5 ICE Service Processing Center (SPC). An ICE owned detention facility used to house individuals who have been detained by ICE because of questions about their immigration status. SPCs were formerly owned and operated by ICE. Now, however, SPCs are owned by ICE but operated by private sector companies. The SPCs are among several different types of facilities commonly used by ICE to house detainees.

#4 USMS IGA         84 U.S. Marshals Service Office [USM]. Holding area in a U.S. Marshals Service office.



# plot levels
ggplot(df, aes(Facility_Type)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, size = 10))

# convert to factor
df <- df %>%
  mutate(Facility_Type = as.factor(Facility_Type))

# check proportions
table(df$Facility_Type)
tab1 <- table(df$Facility_Type)
prop.table(tab1)
df %>%
  count(Facility_Type)
```

#### Authorization status
```{r Authorization_Status, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Authorization_Status                   
# check levels
class(df$Authorization_Status)
class(df$`Authorization_Status`)
class(df$"Authorization_Status")

df %>%
  count(Authorization_Status) # 214 rows
df %>%
  count(`Authorization_Status`) # 214 rows
df %>%
  count("Authorization_Status") # 214 rows
```

#### Authorizing authority
```{r Authorizing_Authority, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# Authorizing_Authority                   
# check levels
class(df$Authorizing_Authority)
class(df$`Authorizing_Authority`)
class(df$"Authorizing_Authority")

df %>%
  count(Authorizing_Authority) # 2 rows
df %>%
  count(`Authorizing_Authority`) # 2 rows
df %>%
  count("Authorizing_Authority") # 214 obs

# plot levels
ggplot(df, aes(Authorizing_Authority)) + 
  geom_bar() +
  theme(axis.text.x = element_text(size = 10))

# convert to factor
df <- df %>%
  mutate(Authorizing_Authority = as.factor(Authorizing_Authority))

# check proportions
table(df$Authorizing_Authority)
tab1 <- table(df$Authorizing_Authority)
prop.table(tab1)
df %>%
  count(Authorizing_Authority)
```

### Average daily population (ADP)
The average daily population for each detention facility is available for nine consecutive years, 2011--2019. Below, I calculate summary statistics and plot distributions for these variables.
 
```{r Average_Daily_Population, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}
# FY19_ADP
summarize(df, `Fiscal Year` = "2019", 
          `Average Daily Popluation` = mean(FY19_ADP)) %>%
  pander()
  # calculate summary statistics
  summary(select(df, FY19_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_ADP))
  
# FY18_ADP
summarize(df, `Fiscal Year` = "2018", `Average Daily Popluation` = mean(FY18_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY18_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY18_ADP))
  
# FY17_ADP
summarize(df, `Fiscal Year` = "2017", `Average Daily Popluation` = mean(FY17_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY17_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY17_ADP))
  
# FY16_ADP
summarize(df, `Fiscal Year` = "2016", `Average Daily Popluation` = mean(FY16_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY16_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY16_ADP))
  
# FY15_ADP
summarize(df, `Fiscal Year` = "2015", `Average Daily Popluation` = mean(FY15_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY15_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY15_ADP))
  
# FY14_ADP
summarize(df, `Fiscal Year` = "2014", `Average Daily Popluation` = mean(FY14_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY14_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY14_ADP))
  
# FY13_ADP
summarize(df, `Fiscal Year` = "2013", `Average Daily Popluation` = mean(FY13_ADP))%>% pander()
  # calculate summary statistics
  summary(select(df, FY13_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY13_ADP))
  
  # FY12_ADP
summarize(df, `Fiscal Year` = "2012", `Average Daily Popluation` = mean(FY12_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY12_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY12_ADP))
  
  # FY11_ADP
summarize(df, `Fiscal Year` = "2011", `Average Daily Popluation` = mean(FY11_ADP)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY11_ADP))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY11_ADP))
```

Average daily population is also available by gender and offense, but only for fiscal year 2019.

```{r Average_Daily_Population_Gender_Offense, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}

# FY19_ADP_Male_Crim
summarize(df, `Fiscal Year` = "2019", 
          `Average Daily Popluation (Male, Criminal)` = mean(FY19_ADP_Male_Crim)) %>%
  pander()
  # calculate summary statistics
  summary(select(df, FY19_ADP_Male_Crim))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_ADP_Male_Crim))
  
# FY19_ADP_Male_NonCrim
summarize(df, `Fiscal Year` = "2019", 
          `Average Daily Popluation (Male, NonCriminal)` = mean(FY19_ADP_Male_NonCrim)) %>%
  pander()
  # calculate summary statistics
  summary(select(df, FY19_ADP_Male_NonCrim))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_ADP_Male_NonCrim))  
  # FY19_ADP_Female_Crim
summarize(df, `Fiscal Year` = "2019", 
          `Average Daily Popluation (Female, Criminal)` = mean(FY19_ADP_Female_Crim)) %>%
  pander()
  # calculate summary statistics
  summary(select(df, FY19_ADP_Female_Crim))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_ADP_Female_Crim))
  
# FY19_ADP_Female_NonCrim
summarize(df, `Fiscal Year` = "2019", 
          `Average Daily Popluation (Female, NonCriminal)` = mean(FY19_ADP_Female_NonCrim)) %>%
  pander()
  # calculate summary statistics
  summary(select(df, FY19_ADP_Female_NonCrim))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_ADP_Female_NonCrim))  
```

```{r Gender_Offense, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}

# Besides investigating sets of existing columns, it is useful to add new columns that are functions of existing columns.
#### Gender
# The population is divided into male and female immigrant detainees.

# ```{r Average_Daily_Population_Gender, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}

# # FY19_ADP_Male and FY19_ADP_Female
# df <- df %>%
#   mutate(
#     FY19_ADP_Male = FY19_ADP_Male_Crim + FY19_ADP_Male_NonCrim,
#     FY19_ADP_Female = FY19_ADP_Female_Crim + FY19_ADP_Female_NonCrim
#   )
# 
# # FY19_ADP_Male
# summarize(df, `Fiscal Year` = "2019", `Average Daily Population, Male` = mean(FY19_ADP_Male)) %>% pander()
#   
# # calculate summary statistics
#   summary(select(df, FY19_ADP_Male))
#   
#   # plot levels
#   ggplot(df) + 
#     geom_histogram(mapping = aes(x = FY19_ADP_Male))
# 
# # FY19_ADP_Female
# summarize(df, `Fiscal Year` = "2019", `Average Daily Population, Female` = mean(FY19_ADP_Female)) %>% pander()
#   
# # calculate summary statistics
#   summary(select(df, FY19_ADP_Female))
#   
#   # plot levels
#   ggplot(df) + 
#     geom_histogram(mapping = aes(x = FY19_ADP_Female))
#```

#### Offense
# The criminal status of an immigrant in detention is also indicated in the data frame.
# 
# ```{r Average_Daily_Population_Offense, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}

# # FY19_ADP_Crim and FY19_ADP_NonCrim
# df <- df %>%
#   mutate(
#     FY19_ADP_Crim = FY19_ADP_Male_Crim + FY19_ADP_Female_Crim,
#     FY19_ADP_NonCrim = FY19_ADP_Male_NonCrim  + FY19_ADP_Female_NonCrim
#   )
# 
# # FY19_ADP_Crim
# summarize(df, `Fiscal Year` = "2019", `Average Daily Population, Criminal Offense` = mean(FY19_ADP_Crim)) %>% pander()
#   
# # calculate summary statistics
#   summary(select(df, FY19_ADP_Crim))
#   
#   # plot levels
#   ggplot(df) + 
#     geom_histogram(mapping = aes(x = FY19_ADP_Crim))
# 
# # FY19_ADP_NonCrim
# summarize(df, `Fiscal Year` = "2019", `Average Daily Population, Non-criminal Offense` = mean(FY19_ADP_NonCrim)) %>% pander()
#   
# # calculate summary statistics
#   summary(select(df, FY19_ADP_NonCrim))
#   
#   # plot levels
#   ggplot(df) + 
#     geom_histogram(mapping = aes(x = FY19_ADP_NonCrim))
```

The probability distributions of the average daily population for the facilities in every year and by subgroup is skewed right. That is, in every year, there are many more facilities that hold very few detainees than there are few facilities that hold many detainees.


First, I will calculate summary statistics for these variables and plot their distributions.

### Initial book-ins
Initial book-ins are available for 2011--2019. These variables have similar distributions to the ADP variables above. A book-in is defined as XXXX. 

```{r InitialBookins, echo=FALSE, results='hide', warning=FALSE, message =FALSE, include=FALSE}

# FY19_InitialBookins
summarize(df, `Fiscal Year` = "2019", `Initial Bookins` = mean(FY19_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY19_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY19_InitialBookins))
  
# FY18_InitialBookins
summarize(df, `Fiscal Year` = "2018", `Initial Bookins` = mean(FY18_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY18_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY18_InitialBookins))
  
# FY17_InitialBookins
summarize(df, `Fiscal Year` = "2017", `Initial Bookins` = mean(FY17_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY17_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY17_InitialBookins))
  
# FY16_InitialBookins
summarize(df, `Fiscal Year` = "2016", `Initial Bookins` = mean(FY16_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY16_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY16_InitialBookins))
  
# FY15_InitialBookins
summarize(df, `Fiscal Year` = "2015", `Initial Bookins` = mean(FY15_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY15_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY15_InitialBookins))
  
# FY14_InitialBookins
summarize(df, `Fiscal Year` = "2014", `Initial Bookins` = mean(FY14_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY14_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY14_InitialBookins))
  
# FY13_InitialBookins
summarize(df, `Fiscal Year` = "2013", `Initial Bookins` = mean(FY13_InitialBookins))%>% pander()
  # calculate summary statistics
  summary(select(df, FY13_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY13_InitialBookins))
  
  # FY12_InitialBookins
summarize(df, `Fiscal Year` = "2012", `Initial Bookins` = mean(FY12_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY12_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY12_InitialBookins))
  
  # FY11_InitialBookins
summarize(df, `Fiscal Year` = "2011", `Initial Bookins` = mean(FY11_InitialBookins)) %>% pander()
  # calculate summary statistics
  summary(select(df, FY11_InitialBookins))
  
  # plot levels
  ggplot(df) + 
    geom_histogram(mapping = aes(x = FY11_InitialBookins))
```

Now that I have the ICE facility-level data loaded into `R` and processed to be technically correct, I create an additional data frame that reshapes the data from long to wide.

### Reshape data wide to long
Longitudinal data are especially useful for understanding change over time within a household and individual. Such data are structured in long-format, requiring a particular set of statistical techniques to remove bias associated with interdependence of repeated measures.

Data in long format differ from data in wide format with regard to their analytical requirements. At the conclusion of wranging these data, I will be able to provide both cross-sectional and longitudinal analyses of ICE detention facilities.

```{r pivoting, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
df.l <- df %>%
  pivot_longer(
    cols = starts_with("FY"),
    names_to = "key",
    values_to = "cases",
  ) %>%
  separate(key, 
           c("Fiscal_Year", 
             "Type", 
             "Sex",
             "Offense"), 
           sep = "_"
           ) %>% 
  pivot_wider(names_from = c(Type, Sex, Offense), 
              values_from = cases)

# rename columns
df.l <- df.l %>%
  rename(ADP = ADP_NA_NA) %>%
  rename(InitialBookins = InitialBookins_NA_NA)

# convert to factor
df.l <- df.l %>%
  mutate(Fiscal_Year = as.factor(Fiscal_Year))
class(df.l) 

# recode variable values
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY19'] <- '2019'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY18'] <- '2018'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY17'] <- '2017'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY16'] <- '2016'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY15'] <- '2015'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY14'] <- '2014'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY13'] <- '2013'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY12'] <- '2012'
levels(df.l$Fiscal_Year)[levels(df.l$Fiscal_Year)=='FY11'] <- '2011'
```






I explore the distribution of each of the average daily population (ADP) variables in the ICE facilities dataset.

For continuous variables, we can measure the centrality and the spread.  Measures of centrality are mean, median. Measures of spread are standard deviation, quantiles, min and max, range, interquartile range.

Second, create new variables with functions of existing variables (mutate()).

Third, collapse many values down to a single summary (summarise()). I use these in conjunction with group_by() which changes the scope of each function from operating on the entire dataset to operating on it group-by-group.




Because our unit of analysis is the AOR, I change the scope of each function from operating on the entire dataset to operating on it group-by-group. That is, I collapse the many facility-level values down to a single summary at the AOR-level.

### Area of Responsibility (AOR)
There are three steps to prepare these data. First, I group facilities by area of responsibility (AOR). Second, I summarize across AORs to compute average daily population and number of facilities.

```{r df.aor, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}
# by_aor <- df %>% 
#   select(Facility_AOR, DETLOC, Facility_City, Facility_Zip, everything()) %>%
#   arrange(Facility_AOR, DETLOC, Facility_City, Facility_Zip)
by_aor <- df
# count number of unique AORs
by_aor %>%
  count(Facility_AOR) # 214 facilities in 24 AORs 
  #df %>% count(n_distinct(Facility_AOR))
  # unique(df$Facility_AOR)
  # count number of AORs
 # df %>% group_by(Facility_AOR) %>% tally() %>% pander()

# view AORs with a bar chart
by_aor %>%
  mutate(Facility_AOR = Facility_AOR %>% fct_infreq() %>% fct_rev()) %>%
  ggplot(aes(Facility_AOR)) +
    geom_bar() +
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = .5))

# aggregate facilities to AOR
by_aor <- by_aor %>%
  #select(Facility_AOR, everything()) %>%
  group_by(Facility_AOR) %>% 
  mutate(N_DETLOC = n_distinct(DETLOC),
         N_City = n_distinct(Facility_City),
         N_State = n_distinct(Facility_State),
         N_Zip = n_distinct(Facility_Zip)) %>%
  group_by(Facility_AOR, N_DETLOC, N_City, N_State, N_Zip) %>%
  summarize_at(vars(starts_with("FY")), mean) %>%
#summarize_at(vars(starts_with("FY")), list(Mean = mean, Count = sum))
  ungroup()

by_aor %>%
  count(Facility_AOR)
    # mutate_at(vars(starts_with("FY")), sum)

# by_aor <- by_aor %>%
#   rename(FY19_ADP = FY19_ADP_Mean) %>%
#   rename(FY18_ADP = FY18_ADP_Mean) %>%
#   rename(FY17_ADP = FY17_ADP_Mean) %>%
#   rename(FY16_ADP = FY16_ADP_Mean) %>%
#   rename(FY15_ADP = FY15_ADP_Mean) %>%
#   rename(FY14_ADP = FY14_ADP_Mean) %>%
#   rename(FY13_ADP = FY13_ADP_Mean) %>%
#   rename(FY12_ADP = FY12_ADP_Mean) %>%
#   rename(FY11_ADP = FY11_ADP_Mean) %>%
#   rename(FY19_ADP_Male_Crim = FY19_ADP_Male_Crim_Mean) %>%
#   rename(FY19_ADP_Male_NonCrim = FY19_ADP_Male_NonCrim_Mean) %>%
#   rename(FY19_ADP_Female_Crim =  FY19_ADP_Female_Crim_Mean) %>%
#   rename(FY19_ADP_Female_NonCrim = FY19_ADP_Female_NonCrim_Mean) %>%
#   rename(FY19_InitialBookins =  FY19_InitialBookins_Mean) %>%
#   rename(FY18_InitialBookins = FY18_InitialBookins_Mean) %>%
#   rename(FY17_InitialBookins = FY17_InitialBookins_Mean) %>%
#   rename(FY16_InitialBookins = FY16_InitialBookins_Mean) %>%
#   rename(FY15_InitialBookins = FY15_InitialBookins_Mean) %>%
#   rename(FY14_InitialBookins = FY14_InitialBookins_Mean) %>%
#   rename(FY13_InitialBookins = FY13_InitialBookins_Mean) %>%
#   rename(FY12_InitialBookins = FY12_InitialBookins_Mean) %>%
#   rename(FY11_InitialBookins = FY11_InitialBookins_Mean) # %>%
#   rename(FY19_ADP_Total = FY19_ADP_Count) %>%
#   rename(FY18_ADP_Total = FY18_ADP_Count) %>%
#   rename(FY17_ADP_Total = FY17_ADP_Count) %>%
#   rename(FY16_ADP_Total = FY16_ADP_Count) %>%
#   rename(FY15_ADP_Total = FY15_ADP_Count) %>%
#   rename(FY14_ADP_Total = FY14_ADP_Count) %>%
#   rename(FY13_ADP_Total = FY13_ADP_Count) %>%
#   rename(FY12_ADP_Total = FY12_ADP_Count) %>%
#   rename(FY11_ADP_Total = FY11_ADP_Count) %>%
#   rename(FY19_ADP_Male_Crim_Total = FY19_ADP_Male_Crim_Count) %>%
#   rename(FY19_ADP_Male_NonCrim_Total = FY19_ADP_Male_NonCrim_Count) %>%
#   rename(FY19_ADP_Female_Crim_Total =  FY19_ADP_Female_Crim_Count) %>% 
#   rename(FY19_ADP_Female_NonCrim_Total = FY19_ADP_Female_NonCrim_Count) %>%
#   rename(FY19_InitialBookins_Total =  FY19_InitialBookins_Count) %>% 
#   rename(FY18_InitialBookins_Total = FY18_InitialBookins_Count) %>% 
#   rename(FY17_InitialBookins_Total = FY17_InitialBookins_Count) %>% 
#   rename(FY16_InitialBookins_Total = FY16_InitialBookins_Count) %>% 
#   rename(FY15_InitialBookins_Total = FY15_InitialBookins_Count) %>% 
#   rename(FY14_InitialBookins_Total = FY14_InitialBookins_Count) %>% 
#   rename(FY13_InitialBookins_Total = FY13_InitialBookins_Count) %>% 
#   rename(FY12_InitialBookins_Total = FY12_InitialBookins_Count) %>% 
#   rename(FY11_InitialBookins_Total = FY11_InitialBookins_Count)
```


```{r pivoting_aor, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# View(df)
# View(by_aor)

by_aor_long <- by_aor %>%
  pivot_longer(
    cols = starts_with("FY"),
    names_to = "key",
    values_to = "cases",
  )  %>% 
  separate(key, 
           c("Fiscal_Year", 
             "Type", 
             "Sex",
             "Offense"), 
           sep = "_"
           ) %>% 
  pivot_wider(names_from = c(Type, Sex, Offense), 
              values_from = cases)
# View(by_aor_long)

# rename columns
by_aor_long <- by_aor_long %>%
  rename(ADP = ADP_NA_NA) %>%
  rename(InitialBookins = InitialBookins_NA_NA)

# convert to factor
by_aor_long <- by_aor_long %>%
  mutate(Fiscal_Year = as.factor(Fiscal_Year))
class(by_aor_long) 

# recode variable values
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY19'] <- '2019'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY18'] <- '2018'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY17'] <- '2017'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY16'] <- '2016'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY15'] <- '2015'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY14'] <- '2014'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY13'] <- '2013'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY12'] <- '2012'
levels(by_aor_long$Fiscal_Year)[levels(by_aor_long$Fiscal_Year)=='FY11'] <- '2011'
```


With the facility-level data structured in both long and wide formats, we can start to describe univariate statistics and covariation between variables of interest using numerical summaries and graphical displays.

The following analyses describes the ICE facilities dataset, which includes both continuous and categorical variables. A variable is continuous if it can take any of an infinite set of ordered values (e.g., income). There are several different plots that can effectively communicate the different features of continuous variables. Features I am generally interested in include measures of location and spread, symmetry, and outliers. In contrast, a categorical variable is a variable that can take on one of a limited, and usually fixed, number of possible values, assigning each individual or other unit of observation to a particular group or nominal category on the basis of some qualitative property (e.g., race-ethnicity, gender, citizenship). There are a few different plots that can effectively communicate features of categorical variables. The features of these variables in which I am generally interested cover counts and proportions.

# Exploratory Data Analysis (EDA)
The CMTO project collects data on the characteristics of both households and individuals within those households. This survey includes information on facility location, household composition and characteristics, and socioeconomic characteristics. First, the geographic context in which households are situated is determined. Second, households within these geographies are characterized by wealth, size, number of children, age and sex composition and structure, and expenditures on rental units. Third, individual-level indicators provide additional characteristics of household head, children, and other household members. These data on individuals are collected on variables such as race-ethnicity, gender, age, homeless status, disability status, relationship to the household head. 

The analytical framework implemented in this analysis illustrates these interrelationships. This framework can be used to analyze data on households' outcomes in economic attainment, educational achievement, and access to geographic opportunity by a great many demographic, housing, and socioeconomic indicators.

## Sample selection
Two questions I will be answering in this section are:

* What type of variation occurs within my variables?

* What type of covariation occurs between my variables?

The current anal ysis is interested in the characteristics of AORs in 2011 through 2019. For this purpose, I aggregate characteristics of facilities before recalculating summary statistics.

The full sample, however, is much larger. The total number of participants and households is `r format(df.demog %>% summarise(count = n_distinct(member_ssn)), big.mark = ",")` and `r df.demog %>% summarise(count = n_distinct(entityid))`, respectively.

```{r adp_by_year, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}

# # compute rate per 10,000
# table1 %>% 
#   mutate(rate = cases / population * 10000)

# visualize changes over time
aor_by_year <- ggplot(data = by_aor_long, 
       aes(x = Fiscal_Year, y = ADP, 
           group = Facility_AOR)) +
  geom_line() +
  xlab("Year") + 
  ylab("Average Daily Population") +
  ggtitle("Average Daily Population, 2011--2019") +
  theme_bw(base_size=8) + 
  theme(axis.text.x = element_text(angle = 90, size = 10)) +
  facet_wrap(~ Facility_AOR)

aor_by_year
```


```{r cert_type, echo=FALSE, results='hide', warning=FALSE, message=FALSE, include=FALSE}

# cert_type
# check levels
class(df$cert_type)

df %>%
  count(cert_type)
table(df$cert_type)

# plot levels
ggplot(df, aes(cert_type)) + 
  geom_bar()  +
  theme(axis.text.x = element_text(angle = 90, size = 10)) + 
  facet_grid()

# check proportions
table(df$cert_type)
tab1 <- table(df$cert_type)
prop.table(tab1)

# generate proportion variable
df <- df %>% 
  left_join(
    df %>% 
      group_by(cert_type) %>% 
      summarize(n = n()) %>% 
      mutate(cert_type_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df$n <- NULL

# create a reusable ggplot object
(ggplot(df, aes(cert_type)) + 
  geom_bar(fill = 'blueviolet') +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = .5)) +
  labs(x = 'Certification Type', y = 'Count',
       title = 'Number of Participants by Certification Type'))
```

Together, the sample of `new admissions` and `issuances of vouchers` contains approximately `r round((0.363+0.505)*100)` percent of the full CMTO sample. Because these descriptive analyses are interested in the attributes of both households as well as youth according to eligibility requirements, I design two samples subsetting household heads and their school-aged children between 15 and 18 years old. The bar chart below illstrates household composition across the full sample by certification type.

```{r member_relation_cert_type_vis, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# new admission and issuance of voucher subsample
df.newadmission.issuance <- df %>% 
  filter(cert_type == "Issuance of Voucher" | 
           cert_type == "New Admission")

ggplot(df.newadmission.issuance, 
       aes(cert_type)) + 
  geom_bar(aes(fill = member_relation)) +
  scale_fill_brewer(palette="Spectral") +
  theme(axis.text.x = element_text(angle = 45, size = 10, vjust = .5)) +
  labs(x = 'Certification Type', y = 'Count',
       title = 'Number of Participants by Certification Type and Relationship to Household Head') 
```

Across samples, the majority of individuals are considered heads of households and youth under the age of 18.

```{r newadmission_subsamples, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# full new admission subsample
 df.demog.newadmission <- df %>%
  filter(cert_type == "New Admission")

# household-level subsample
      df.demog.newadmission.hoh <- df %>%
        filter(cert_type == "New Admission" & member_relation == "Head Of Household")
        # verify unique IDs
          df.demog.newadmission.hoh %>%
            count(entityid) %>%
            filter(n > 1)# one duplicate entityid == 127429
                    df.test <- df.demog.newadmission.hoh %>% filter(entityid == "127429")
    
# child-level subsample
    df.demog.newadmission.child <- df %>%
      filter(cert_type == "New Admission" &
               age_num == 15:18)
        # verify unique IDs
          df.demog.newadmission.child %>%
            count(member_ssn) %>%
            filter(n > 1)  # no duplicates
```
By counting the number of rows in the new admissions data frame, the total number of survey participants is ``r df.demog.newadmission %>% summarise(count = n_distinct(member_ssn))`` and the total number of households represented in the data frame is `r df.demog.newadmission %>% summarise(count = n_distinct(entityid))`. 

```{r }
#df.demog.w.ind %>% 
#  filter(age_num == 15) %>% 
#  count(n_distinct(entityid_time1))

#names(df.demog.w.ind)

#df %>%
#  filter(cert_type == "New Admission") %>% 
#  summarise(count = n_distinct(entityid))
```

Of the new admissions, a total of `r df.demog.newadmission.child %>% summarize(count = n_distinct(entityid))` households have children aged between the years of 15 and 18.

```{r issuance_subsamples, echo=FALSE, results='hide', warning=FALSE, message=FALSE}

# full issuance of voucher subsample
 df.demog.issuance <- df %>% 
   filter(cert_type == "Issuance of Voucher")
 
# household-level subsample
       df.demog.issuance.hoh <- df %>%
        filter(cert_type == "Issuance of Voucher" & member_relation == "Head Of Household")
        # verify unique IDs
          df.demog.issuance.hoh %>%
            count(entityid) %>%
            filter(n > 1)
          
# child-level subsample
     df.demog.issuance.child <- df %>%
       filter(cert_type == "Issuance of Voucher" & 
                age_num == 15:18)
        # verify unique IDs
          df.demog.issuance.child %>%
            count(member_ssn) %>%
            filter(n == 1) 
```
By contrast, the data frame subsetting on issuance of vouchers has a total number of participants equal to `r df.demog.issuance %>% summarise(count = n_distinct(member_ssn))`. The total number of households in this truncated dataset amounts to `r df.demog.issuance %>% summarise(count = n_distinct(entityid))`. For households issued vouchers, `r df.demog.issuance.child %>% summarize(count = n_distinct(entityid))` have youth who are between 15 and 18 years of age.



## Summarizing and visualizing distributions


It is important to be able to understand how an individual variable is distributed before moving on to more sophisticated visualizations that enable multidimensional investigation. Visually understanding the distribution allows us to describe many features of a variable.

### Variation
I first present several numerical summaries and create graphical displays showing the univariate distributions of different variables that are of interest to the Human Rights at Home project .

#### Creating Moves to Opportunity (CMTO) treatment
```{r newadmission_hoh_cmto_treatment_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot distribution
ggplot(df.demog.newadmission.hoh, aes(cmto_treatment)) + 
  geom_bar(fill = 'thistle') +
  theme_minimal() +
  labs(x = 'CMTO Treatment', y = 'Count',
       title = 'Number of Households by Treatment Group',
       subtitle = 'New Admissions')
names(df.demog.newadmission.hoh)

# check proportions
table(df.demog.newadmission.hoh$cmto_treatment)
  tab1 <- table(df.demog.newadmission.hoh$cmto_treatment)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(cmto_treatment) %>% 
      summarize(n = n()) %>% 
      mutate(cmto_treatment_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL
```
CMTO households who were new admissions comprise `r round(0.4722222*100, digits = 2)` percent of the treatment group in this sample. Comparatively, approximately `r round(0.5277778*100, digits = 2)` percent of households were in the control group.
```{r newadmission_cmto_treatment_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot distribution
ggplot(df.demog.newadmission, aes(cmto_treatment)) + 
  geom_bar(fill = 'thistle') +
  theme_minimal() +
  labs(x = 'CMTO Treatment', y = 'Count',
       title = 'Number of Participants by Treatment Group',
       subtitle = 'New Admissions')
names(df.demog.newadmission)

# check proportions
table(df.demog.newadmission$cmto_treatment)
  tab1 <- table(df.demog.newadmission$cmto_treatment)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(cmto_treatment) %>% 
      summarize(n = n()) %>% 
      mutate(cmto_treatment_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL

#Of the new admission sample, `r round(0.5324427 * 100, digits = 2)` percent are in the treatment condition and `r round(0.4675573 * 100, digits = 2)` percent are in the control group.
```

Issuances of vouchers, in contrast, appear to be symmetrically distributed between treatment and control groups. 
```{r issuance_hoh_cmto_treatment_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot distribution
ggplot(df.demog.issuance.hoh, aes(cmto_treatment)) + 
  geom_bar(fill = 'thistle') +
  theme_minimal() +
  labs(x = 'CMTO Treatment', y = 'Count',
       title = 'Number of Households by Treatment Group',
       subtitle = 'Issuance of Vouchers')
names(df.demog.issuance.hoh)

# check proportions
table(df.demog.issuance.hoh$cmto_treatment)
  tab1 <- table(df.demog.issuance.hoh$cmto_treatment)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(cmto_treatment) %>% 
      summarize(n = n()) %>% 
      mutate(cmto_treatment_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```

Among certification type `Issuance of Voucher`, households in the control group made up `r round(0.5025381*100, digits = 2)` of the total sample while households in the treatment group accounted for `r round(0.4974619*100, digits = 2)` of the share.

```{r issuance_cmto_treatment_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot distribution
ggplot(df.demog.issuance, aes(cmto_treatment)) + 
  geom_bar(fill = 'thistle') +
  theme_minimal() +
  labs(x = 'CMTO Treatment', y = 'Count',
       title = 'Number of Participants by Treatment Group',
       subtitle = 'Issuance of Vouchers')
names(df.demog.issuance)

# check proportions
table(df.demog.issuance$cmto_treatment)
  tab1 <- table(df.demog.issuance$cmto_treatment)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(cmto_treatment) %>% 
      summarize(n = n()) %>% 
      mutate(cmto_treatment_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL
```

##### Race-ethnicity
Race-ethnicity refers to the racial or ethnic group with which a person identified himself or herself.

```{r newadmission_race_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.newadmission %>%
  count(race_ethnicity)

# check levels by entityid
df.demog.newadmission %>% 
  group_by(entityid, race_ethnicity) %>% 
  summarize(n = n()) %>%
  spread(key = entityid, value = n)

# check proportions
table(df.demog.newadmission$race_ethnicity)
  tab1 <- table(df.demog.newadmission$race_ethnicity)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(race_ethnicity) %>% 
      summarize(n = n()) %>% 
      mutate(race_ethnicity_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL


# plot levels
ggplot(df.demog.newadmission, aes(race_ethnicity)) + 
  geom_bar(fill='darkblue') +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 40, vjust = .75)) +
  labs(x = 'Race-ethnicity', y = 'Count',
       title = 'Number of Participants by Race-ethnicity',
              subtitle = 'New Admissions')
```

The bar chart above indicates the racial and ethnic distribution of the full sample of new admissions, with the majority of participants self-identifying with the African American/Black category. Approximately `r round(0.530534351 * 100)` percent of the CMTO sample identified as African American or Black. Together, the remaining ethnoracial groups make-up `r round((0.062977099 + 0.122137405 + 0.051526718 + 0.009541985 + 0.019083969 + 0.204198473) * 100, digits = 2)` percent of the population. Less than one percent of the sample is indigenous (`r round(0.009541985, digits = 2)` percent) or Native Hawaiian (`r round(0.019083969, digits = 2)` percent). Asian participants constitute approximately `r round(0.062977099 * 100, digits = 2)` percent of the overall sample. Respondents identifying as white are the second largest group represented in these data (`r round(0.204198473 * 100, digits = 2)` percent), while the Latinx community comprises the third largest group (`r round(0.122137405 * 100, digits = 2)` percent). Multi-racial participants made up about `r round(0.051526718 * 100, digits = 2)` percent of the total respondents.

```{r issuance_race_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.issuance %>%
  count(race_ethnicity)

# check levels by entityid
df.demog.issuance %>% 
  group_by(entityid, race_ethnicity) %>% 
  summarize(n = n()) %>%
  spread(key = entityid, value = n)

# check proportions
table(df.demog.issuance$race_ethnicity)
  tab1 <- table(df.demog.issuance$race_ethnicity)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(race_ethnicity) %>% 
      summarize(n = n()) %>% 
      mutate(race_ethnicity_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL


# plot levels
ggplot(df.demog.issuance, aes(race_ethnicity)) + 
  geom_bar(fill='darkblue') +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 40, vjust = .75)) +
  labs(x = 'Race-ethnicity', y = 'Count',
       title = 'Number of Participants by Race-ethnicity',
       subtitle = 'Issuance of Vouchers') 
```

For individuals with an issued voucher, approximately `r round(0.54458162 * 100, digits = 2)` percent self-identify as African American or Black. A little over one percent of the sample is indigenous (`r round(0.01097394 * 100, digits = 2)` percent). Native Hawaiians represent approximately `r round(0.03429355 * 100, digits = 2)` percent of the total sample. Asian participants constitute approximately `r round(0.05486968 * 100, digits = 2)` percent of the overall sample. Respondents identifying as white are also the second largest group represented among this sample of the data (`r round(0.19753086 * 100, digits = 2)` percent). Similarly, the Latinx community comprises `r round(0.11111111  * 100, digits = 2)` percent of those persons who were issued a voucher. Multi-racial participants made up about `r round(0.04663923 * 100, digits = 2)` percent of the total respondents.

##### Age
Numerical and graphical summaries below display the age distribution of CMTO participants.

```{r newadmission_age_num_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.newadmission %>%
  count(age_num)

df.demog.newadmission %>%
  summarise(count = n_distinct(age_num)) # 62 unique ages

# check proportions
table(df.demog.newadmission$age_num)
  tab1 <- table(df.demog.newadmission$age_num)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(age_num) %>% 
      summarize(n = n()) %>% 
      mutate(age_num_prop_newadmission = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL

## create a reusable ggplot object
#gg_prop <- ggplot(data = data.frame()
#                  , aes(x = age_num, y = age_num_prop)) + 
#  geom_bar(stat = 'identity', position = 'dodge', alpha = 2/3) +  
#  scale_y_continuous(labels = percent) + 
#  labs(x = 'Age (years)', y = NULL,
#       title = 'Proportions in Age')  # what's the reader looking at?
#gg_prop %+%   # use %+% to add...
#  df.demog.newadmission    # a dataframe

# plot levels
ggplot(df.demog.newadmission, aes(age_num)) + 
  geom_bar(fill = 'darkred') +
  theme_minimal() +
  labs(x = 'Age (years)', y = 'Count',
       title = 'Number of Participants by Age',
       subtitle = 'New Admissions')

# summarize variable
summary(df.demog.newadmission$age_num)
```

The graph shows age ranges from `r min(df.demog.newadmission$age_num)` (i.e., less than a year old) to `r max(df.demog.newadmission$age_num)` years, with `r df.demog.newadmission %>% summarise(count = n_distinct(age_num))` different ages represented. These data also suggest that the full CMTO sample is young. For example, the median age of `r round(median(df.demog.newadmission$age_num))` is smaller than the mean age of `r round(mean(df.demog.newadmission$age_num))`, suggesting the distribution of this variable is skewed right. Individuals in the sample of voucher-holders reflect a similar age distribution as those in the sample of new admissions.

```{r issuance_age_num_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.issuance %>%
  count(age_num)

df.demog.issuance %>%
  summarise(count = n_distinct(age_num)) # 62 unique ages

# check proportions
table(df.demog.issuance$age_num)
  tab1 <- table(df.demog.issuance$age_num)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(age_num) %>% 
      summarize(n = n()) %>% 
      mutate(age_num_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL

# plot levels
ggplot(df.demog.issuance, aes(age_num)) + 
  geom_bar(fill = 'darkred') +
  theme_minimal() +
  labs(x = 'Age (years)', y = 'Count',
       title = 'Number of Participants by Age',
       subtitle = 'Issuance of Vouchers')

# summarize variable
summary(df.demog.issuance$age_num)
```

##### Household family size
Household family size captures the number of own family members residing with each individual considered to be the head of the household, including the person her/himself. This statistic excludes live-in aids.

```{r newadmission_hh_fam_size_vis, eval = TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission.hoh %>%
  count(hh_fam_size)

# plot levels
ggplot(df.demog.newadmission.hoh, aes(factor(hh_fam_size))) + 
  geom_bar(fill = '#56B4E9') +
  theme_minimal() +
  labs(x = 'Household family size', y = 'Count',
       title = 'Size of Family Household') 

# check proportions
table(df.demog.newadmission.hoh$hh_fam_size)
  tab1 <- table(df.demog.newadmission.hoh$hh_fam_size)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(hh_fam_size) %>% 
      summarize(n = n()) %>% 
      mutate(hh_fam_size_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL

# generate average family size
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  mutate(avg_hh_fam_size_num = mean(hh_fam_size))
```

Family size varies across new admissions. However, the vast majority of families live in households with two to five members. The distribution for vouchers issued is graphed below.

```{r issuance_hh_fam_size_vis, eval = TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance.hoh %>%
  count(hh_fam_size)

# plot levels
ggplot(df.demog.issuance.hoh, aes(factor(hh_fam_size))) + 
  geom_bar(fill = '#56B4E9') +
  theme_minimal() +
  labs(x = 'Household family size', y = 'Count',
       title = 'Size of Family Household',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance.hoh$hh_fam_size)
  tab1 <- table(df.demog.issuance.hoh$hh_fam_size)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(hh_fam_size) %>% 
      summarize(n = n()) %>% 
      mutate(hh_fam_size_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL

# generate average family size
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  mutate(avg_hh_fam_size_num = mean(hh_fam_size))
```

##### Gender
```{r newadmission_gender_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission %>%
  count(member_gender)
  # check levels of number of rooms
    # levels(df.demog.newadmission$hh_fam_size)

# plot levels
ggplot(df.demog.newadmission, aes(member_gender)) + 
  geom_bar(fill = 'chartreuse') +
  theme_minimal() +
  labs(x = 'Gender', y = 'Count',
       title = 'Number of Participants by Gender',
       subtitle = 'New Admissions') 

# check proportions
table(df.demog.newadmission$member_gender)
  tab1 <- table(df.demog.newadmission$member_gender)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(member_gender) %>% 
      summarize(n = n()) %>% 
      mutate(member_gender_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL
```

Participants in the CMTO program are overwhelmingly female in the full sample. The above chart indicates, for instance, shows that females are `r round(max(df.demog.newadmission$member_gender_prop), digits = 2)` percent of new admissions. Males comprise about `r round(min(df.demog.newadmission$member_gender_prop), digits = 2)` percent of new admissions. However, analyses of gender by head of household status displays different results.

```{r newadmission_hoh_gender_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission.hoh %>%
  count(member_gender)

# plot levels
ggplot(df.demog.newadmission.hoh, aes(member_gender)) + 
  geom_bar(fill = 'chartreuse') +
  theme_minimal() +
  labs(x = 'Gender', y = 'Count',
       title = 'Number of Participants by Gender',
       subtitle = 'New Admissions') 

# check proportions
table(df.demog.newadmission.hoh$member_gender)
  tab1 <- table(df.demog.newadmission.hoh$member_gender)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(member_gender) %>% 
      summarize(n = n()) %>% 
      mutate(member_gender_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL
```

Approximately `r round(max(df.demog.newadmission.hoh$member_gender_prop), digits = 2)` percent of household heads are female, compared with `r round(min(df.demog.newadmission.hoh$member_gender_prop), digits = 2)`.

For issuances of vouchers, `r round(max(df.demog.issuance.hoh$member_gender_prop), digits = 2)` percent are female while the percent of male-headed households is `r round(min(df.demog.issuance.hoh$member_gender_prop), digits = 2)`. These results are similar to new admissions.

```{r issuance_gender_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance %>%
  count(member_gender)

# plot levels
ggplot(df.demog.issuance, aes(member_gender)) + 
  geom_bar(fill = 'chartreuse4') +
  theme_minimal() +
  labs(x = 'Gender', y = 'Count',
       title = 'Number of Participants by Gender',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance$member_gender)
  tab1 <- table(df.demog.issuance$member_gender)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(member_gender) %>% 
      summarize(n = n()) %>% 
      mutate(member_gender_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL
```


```{r issuance_hoh_gender_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance.hoh %>%
  count(member_gender)

# plot levels
ggplot(df.demog.issuance.hoh, aes(member_gender)) + 
  geom_bar(fill = 'chartreuse4') +
  theme_minimal() +
  labs(x = 'Gender', y = 'Count',
       title = 'Number of Participants by Gender',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance.hoh$member_gender)
  tab1 <- table(df.demog.issuance.hoh$member_gender)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(member_gender) %>% 
      summarize(n = n()) %>% 
      mutate(member_gender_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```


##### Citizenship

```{r newadmission_hoh_citizenship_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.newadmission.hoh %>%
  count(member_citizenship)

# plot levels
ggplot(df.demog.newadmission.hoh, aes(member_citizenship)) + 
  geom_bar(fill = 'royalblue3') +
  theme_minimal() +
  labs(x = 'Citizenship Status', y = 'Count',
       title = 'Number of Participants by Citizenship Status') 

# check proportions
table(df.demog.newadmission.hoh$member_citizenship)
  tab1 <- table(df.demog.newadmission.hoh$member_citizenship)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(member_citizenship) %>% 
      summarize(n = n()) %>% 
      mutate(member_citizenship_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL
```

Most CMTO participants are considered to be citizens eligible for services (i.e., `r round(max(df.demog.newadmission.hoh$member_citizenship_prop), digits = 2)`). Noncitizens who are eligible for services comprise `r round(0.81250000*100, digits= 2)`. Ineligible noncitizens constitute `r round(0.02777778*100, digits = 2)` of the overall households represented in the sample of new admissions.



```{r issuance_hoh_citizenship_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.issuance.hoh %>%
  count(member_citizenship)

# plot levels
ggplot(df.demog.issuance.hoh, aes(member_citizenship)) + 
  geom_bar(fill = 'royalblue3') +
  theme_minimal() +
  labs(x = 'Citizenship Status', y = 'Count',
       title = 'Number of Participants by Citizenship Status') 

# check proportions
table(df.demog.issuance.hoh$member_citizenship)
  tab1 <- table(df.demog.issuance.hoh$member_citizenship)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(member_citizenship) %>% 
      summarize(n = n()) %>% 
      mutate(member_citizenship_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```

##### Homeless
```{r newadmission_hoh_homeless_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission.hoh %>%
  count(homeless)

# plot levels
ggplot(df.demog.newadmission.hoh, aes(homeless)) + 
  geom_bar(fill = 'green4') +
  theme_minimal() +
  labs(x = 'Homeless Status', y = 'Count',
       title = 'Number of Households by Homeless Status') 

# check proportions
table(df.demog.newadmission.hoh$homeless)
  tab1 <- table(df.demog.newadmission.hoh$homeless)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(homeless) %>% 
      summarize(n = n()) %>% 
      mutate(homeless_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL
```

No Yes 
 97  47 

       No       Yes 

The status of homelessness among households were similar in both samples. That is, approximately
`r round(0.6736111*100, digits = 2)` percent of households were not homeless, while `r round(0.3263889*100, digits = 2) percent reported having experienced homelessness.

```{r issuance_hoh_homeless_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance.hoh %>%
  count(homeless)

# plot levels
ggplot(df.demog.issuance.hoh, aes(homeless)) + 
  geom_bar(fill = 'green4') +
  theme_minimal() +
  labs(x = 'Homeless Status', y = 'Count',
       title = 'Number of Participants by Homeless Status') 

# check proportions
table(df.demog.issuance.hoh$homeless)
  tab1 <- table(df.demog.issuance.hoh$homeless)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(homeless) %>% 
      summarize(n = n()) %>% 
      mutate(homeless_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```

##### Disability
```{r newadmission_disability_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission %>%
  count(member_disability)

# plot levels
ggplot(df.demog.newadmission, aes(member_disability)) + 
  geom_bar(fill = 'palevioletred2') +
  theme_minimal() +
  labs(x = 'Disability Status', y = 'Count',
       title = 'Number of Participants with Disabilities') 

# check proportions
table(df.demog.newadmission$member_disability)
  tab1 <- table(df.demog.newadmission$member_disability)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(member_disability) %>% 
      summarize(n = n()) %>% 
      mutate(member_disability_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL
```

Among new admissions, `r round(0.92938931 * 100, digits = 2)` percent do not have a disaibility. A total of `r round(0.07061069 * 100, digits = 2)` percent have a disability.


```{r issuance_disability_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance %>%
  count(member_disability)

# plot levels
ggplot(df.demog.issuance, aes(member_disability)) + 
  geom_bar(fill = 'palevioletred2') +
  theme_minimal() +
  labs(x = 'Disability Status', y = 'Count',
       title = 'Number of Participants with Disabilities') 

# check proportions
table(df.demog.issuance$member_disability)
  tab1 <- table(df.demog.issuance$member_disability)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(member_disability) %>% 
      summarize(n = n()) %>% 
      mutate(member_disability_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL
```

Among issuances of vouchers, `r round(0.93964335 * 100, digits = 2)` percent do not have a disaibility and `r round(0.06035665 * 100, digits = 2)` percent have a disability.

##### Single adult
A description of households headed by single adults is also of interest to the CMTO study. 

```{r newadmission_hoh_single_adult_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.newadmission.hoh %>%
  count(single_adult)

# plot levels
ggplot(df.demog.newadmission.hoh, aes(single_adult)) + 
  geom_bar(fill = 'purple4') +
  theme_minimal() +
  labs(x = 'Single-headed household', y = 'Count',
       title = 'Number of Households with Single Adults',
       subtitle = 'New Admissions') 

# check proportions
table(df.demog.newadmission.hoh$single_adult)
  tab1 <- table(df.demog.newadmission.hoh$single_adult)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  left_join(
    df.demog.newadmission.hoh %>% 
      group_by(single_adult) %>% 
      summarize(n = n()) %>% 
      mutate(single_adult_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission.hoh$n <- NULL
```

Of the `r (41+103)` new admissions, `r round (0.2847222*100, digits = 2)` percent were composed of households with more than one single adult. That is, almost `r round(0.7152778*100, digits =2)` percent of the households are headed by single adults. A similar pattern emerges to describe the sample in which only vouchers were issued.

```{r issuance_hoh_single_adult_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## check levels
df.demog.issuance.hoh %>%
  count(single_adult)

# plot levels
ggplot(df.demog.issuance.hoh, aes(single_adult)) + 
  geom_bar(fill = 'purple4') +
  theme_minimal() +
  labs(x = 'Single-headed households', y = 'Count',
       title = 'Number of Households with Single Adults',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance.hoh$single_adult)
  tab1 <- table(df.demog.issuance.hoh$single_adult)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(single_adult) %>% 
      summarize(n = n()) %>% 
      mutate(single_adult_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```

```{r newadmission_program_type_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
##### Housing program type

## check levels
df.demog.newadmission %>%
  count(program_type)
  # check levels
    # levels(df.demog.newadmission$program_type)

# plot levels
ggplot(df.demog.newadmission, aes(program_type)) + 
  geom_bar(fill = 'palegreen1') +
  theme_minimal() +
  labs(x = 'Housing program type', y = 'Count',
       title = 'Number of Participants by Housing Program Type') 

# check proportions
table(df.demog.newadmission$program_type)
  tab1 <- table(df.demog.newadmission$program_type)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(program_type) %>% 
      summarize(n = n()) %>% 
      mutate(program_type_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL
```

```{r newadmission_program_subtype_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
##### Housing program subtype
## check levels
df.demog.newadmission %>%
  count(housing_program_subtype)
  # check levels
    # levels(df.demog.newadmission$program_type)

# plot levels
ggplot(df.demog.newadmission, aes(housing_program_subtype)) + 
  geom_bar(fill = 'pink') +
  theme_minimal() +
  labs(x = 'Housing program subtype', y = 'Count',
       title = 'Number of Participants by Housing Program Subtype') 

# check proportions
table(df.demog.newadmission$housing_program_subtype)
  tab1 <- table(df.demog.newadmission$housing_program_subtype)
  prop.table(tab1)

# generate proportion variable
df.demog.newadmission <- df.demog.newadmission %>% 
  left_join(
    df.demog.newadmission %>% 
      group_by(housing_program_subtype) %>% 
      summarize(n = n()) %>% 
      mutate(housing_program_subtype_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.newadmission$n <- NULL
```

##### Certification effective date
```{r newadmission_hoh_cert_effective_date_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
##### Certification effective date
## check levels
#df.demog.newadmission.hoh %>%
  count(cert_effective_date)

## plot levels
#ggplot(df.demog.newadmission.hoh, aes(cert_effective_date)) + 
#  geom_bar(fill = 'darkmagenta') +
#  theme_minimal() +
#  labs(x = 'Certification effective date', y = 'Count',
#       title = 'Number of Households by Certification Effective Date',
#       subtitle = 'Issuance of Vouchers') 

## check proportions
#table(df.demog.newadmission.hoh$cert_effective_date)
#  tab1 <- table(df.demog.newadmission.hoh$cert_effective_date)
#  prop.table(tab1)

## generate proportion variable
#df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
#  left_join(
#    df.demog.newadmission.hoh %>% 
#      group_by(cert_effective_date) %>% 
#      summarize(n = n()) %>% 
#      mutate(cert_effective_date_prop = prop.table(n)) # prop = n / sum(n) works too
#    )
#df.demog.newadmission.hoh$n <- NULL
```


```{r issuance_hoh_cert_effective_date_vis, eval=FALSE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.issuance.hoh %>%
  count(cert_effective_date)

#View(df.demog.issuance.hoh)

# plot levels
ggplot(df.demog.issuance.hoh, aes(cert_effective_date)) + 
  geom_bar(fill = 'darkmagenta') +
  theme_minimal() +
  labs(x = 'Certification effective date', y = 'Count',
       title = 'Number of Participants by Certification Effective Date',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance.hoh$cert_effective_date)
  tab1 <- table(df.demog.issuance.hoh$cert_effective_date)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(cert_effective_date) %>% 
      summarize(n = n()) %>% 
      mutate(cert_effective_date_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```


##### Lease date

The variable `lease date` reflects the date on which a household moved into a new unit.

```{r issuance_hoh_lease_date_vis, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# check levels
df.demog.issuance.hoh %>%
  count(lease_date)

#View(df.demog.issuance)

# plot levels
ggplot(df.demog.issuance.hoh, aes(lease_date)) + 
  geom_bar(fill = 'darkolivegreen1') +
  theme_minimal() +
  labs(x = 'Lease date', y = 'Count',
       title = 'Number of Households by Lease Date',
       subtitle = 'Issuance of Vouchers') 

# check proportions
table(df.demog.issuance.hoh$lease_date)
  tab1 <- table(df.demog.issuance.hoh$lease_date)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance.hoh <- df.demog.issuance.hoh %>% 
  left_join(
    df.demog.issuance.hoh %>% 
      group_by(lease_date) %>% 
      summarize(n = n()) %>% 
      mutate(lease_date_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance.hoh$n <- NULL
```

```{r issuance_hoh_duration_date_vis, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
## generate certification duration variable
# plot levels
gg <- ggplot(df.demog.issuance.hoh, aes(x = cert_effective_date, 
                              xend = lease_date, 
                              y = factor(race_ethnicity), 
                              group = factor(entityid))) + 
  geom_dumbbell(color = '#a3c4dc',
                size = 0.75, 
                point.colour.1 = '#0e668b') +
  scale_x_date() +
  theme_minimal() +
  labs(x = NULL, 
       y = NULL, 
       title = 'Time between Certification Effective Date and Lease Date', 
       subtitle = 'Issuance of Vouchers') + 
  theme(plot.title = element_text(hjust=0.5, face="bold"), 
        plot.background=element_rect(fill="#f7f7f7"), 
        panel.background=element_rect(fill="#f7f7f7"), 
        panel.grid.minor=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.major.x=element_line(), 
        axis.ticks=element_blank(), 
        legend.position="top", 
        panel.border=element_blank())
gg

# check proportions
table(df.demog.issuance$lease_date)
  tab1 <- table(df.demog.issuance$lease_date)
  prop.table(tab1)

# generate proportion variable
df.demog.issuance <- df.demog.issuance %>% 
  left_join(
    df.demog.issuance %>% 
      group_by(lease_date) %>% 
      summarize(n = n()) %>% 
      mutate(lease_date_prop = prop.table(n)) # prop = n / sum(n) works too
    )
df.demog.issuance$n <- NULL
```

The dumbbell plot above is a great tool for visualizing relative positions between two points in time. Dumbbell charts also facilitate comparisons in distance between two categories, such as when a voucher was first issued and when a move-in occurs.

In order to get the correct ordering of the dumbbells, the Y variable should be a factor and the levels of the factor variable should be in the same order as it should appear in the plot.

##### Length of housing search
```{r issuance_hoh_cert_duration}
# generate duration between certification dates variable
df.test <- df.demog.issuance.hoh %>%
   mutate(cert_duration = as.duration(cert_effective_date - lease_date))

# generate average duration between certification
df.demog.newadmission.hoh <- df.demog.newadmission.hoh %>% 
  mutate(avg_hh_fam_size_num = mean(hh_fam_size))
```

### Covariation
Bivariate Relationships and Associations
Having a solid understanding of univariate distributions is important; however, most analyses want to take the next step to understand associations and relationships between variables. Features we are generally interested in include:

Associations
Outliers
Clusters
Gaps
Barriers
Change points








```{}
# FOR INCOME VARIABLES WHERE I CAN'T SEE THE FULL DISTRIBUTION BECAUSE THE RANGE IS TOO WIDE
ggplot(df.demog.newadmission) + 
  geom_histogram(mapping = aes(x = age_num), binwidth = 0.5) +
  coord_cartesian(ylim = c(0, 20))
```



```{r newadmission_age_num_race_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot levels
g <- ggplot(df.demog.newadmission, aes(age_num))
g + geom_density(aes(fill = race_ethnicity), alpha=0.8) + 
    labs(title = "Distribution of Age by Race-ethnicity", 
         subtitle = "New Admissions",
         y = "Probability per age (years)",
         x = "Age (years)",
         fill = "Race-ethnicity")
```

Kernel density plots present the probability of an individual occurring within a particular age. This density plot suggests the population of Native Americans and multi-racial individuals in the CMTO sample of new admissions is particularly young. Put differently, the probability that these two ethnoracial groups are represented in children aged 10 is very high. Latinos are overrepresented in the age range between 20 and 30 years. In addition to residents who identified as American Indians, white residents have a high probability of being between the ages of 30 and 40 years. It also appears that the eldest participants among new admissions are Native Hawaiian.

```{r issuance_age_num_race_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# plot levels
g <- ggplot(df.demog.issuance, aes(age_num))
g + geom_density(aes(fill = race_ethnicity), alpha=0.8) + 
    labs(title = "Distribution of Age by Race-ethnicity", 
         subtitle = "Issuance of Vouchers",
         #caption="Source: mpg",
         y = "Probability per age (years)",
         x = "Age (years)",
         fill = "Race-ethnicity")
```

The distribution of age by ethnoracial affiliation is different among the sample of issued vouchers. For example, the probability that a person who identifies as multiracial is 10-years-old is much higher than in the sample of new admissions. Asian participants also appear to be older in the sample of issued vouchers when compared to the sample of new admissions. Latinos and Native Americans have similar probabilities around 10-years-old within this sample.

```{r}
#Dates confirm voucher-holding households moved-in, while issuance of vouchers suggests households are in the process of searching for rental housing. 

#The duration between these dates prompts important questions related to the housing search process, residential mobility, racial equity, and social justice.
```

```{r newadmission_hoh_single_adult_race_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}


# plot levels
ggplot(df.demog.newadmission.hoh, 
       aes(single_adult)) + 
  geom_bar(aes(fill = race_ethnicity)) +
  scale_fill_brewer(palette="Accent") +
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = .5)) +
  labs(x = 'Single-headed household', y = 'Count',
       title = 'Number of Households with Single Adults by Race-Ethnicity',
       subtitle = 'New Admissions')

#How many CMTO participants are elderly?
#How many CMTO participants have a disability?
#How many CMTO participants are single-headed families with children?
```  
  
```{r newadmission_disability_age_num_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# generate binary variable of age
df.demog.newadmission <- df %>% 
  mutate(age_num_cat = as.factor(ifelse(age_num %in% 0:17, "Under-18 years old",
                                     ifelse(age_num %in% 18:100, "18+ years old",
                                            NA))))

# plot levels
ggplot(subset(df.demog.newadmission, member_disability == "Yes"), 
       aes(member_disability)) + 
  geom_bar(aes(fill = age_num_cat), position = 'dodge') +
  scale_fill_brewer(palette="Pastel1") +
  theme(axis.text.x = element_text(size = 10, vjust = .5)) +
  labs(x = 'Disability Status', y = 'Count',
       title = 'Number of Households by Disability Status and Age') 
```

```{r issuance_disability_age_num_vis, eval=TRUE, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# generate binary variable of age
df.demog.issuance <- df %>% 
  mutate(age_num_cat = as.factor(ifelse(age_num %in% 0:17, "Under-18 years old",
                                     ifelse(age_num %in% 18:100, "18+ years old",
                                            NA))))

# plot levels
ggplot(subset(df.demog.issuance, member_disability == "Yes"), 
       aes(member_disability)) + 
  geom_bar(aes(fill = age_num_cat)) +
  scale_fill_brewer(palette="Pastel1") +
  theme(axis.text.x = element_text(angle = 45, size = 10, vjust = .5)) +
  labs(x = 'Disability Status', y = 'Count',
       title = 'Number of Households by Disability Status and Age',
       subtitle = 'Issuance of Vouchers')

```

3. Future research questions:
"After being picked up by ICE officials, either at the Border, through Secure Communities, or by local officials by way of Section 287(g), an individual can be released on bond if they are not deemed a "threat" to national security."


  
  mpg %>%
    ggplot(aes(cty)) +
    geom_histogram(binwidth = 1.25, color = "black",fill = "grey") +
    geom_vline(xintercept = mean(mpg$cty), lwd = 2) +
    labs(title = "Distribution of cty",
         x = "cty",
         y = "Number of cars") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(7.5,35,2.5))

  
  
  
  Bivariate analysis of a continuous variable with respect to a categorical variable
Before we start our calculations, lets continue in a graphical way. Before, we have analyzed the distribution of cty, as shown with the histogram above. Now we want to analyse it for different types of drivings (e.g. 4-wheel drive, front wheel drive or rear wheel drive), as recorded by the variable drv. Graphically, we can plot different histograms for each of these three categories using facets.

mpg %>%
    ggplot(aes(cty)) +
    geom_histogram(binwidth = 1.25, color = "black",fill = "grey") +
    labs(title = "Distribution of cty relative to drv",
         x = "cty",
         y = "Number of cars") +
    theme_minimal() +
    scale_x_continuous(breaks = seq(7.5,35,2.5)) +
    facet_grid(drv~.)
    
    
    Enforcement index by Area of Responsibility (AOR):
Total base capacity for detention centers
Total number of as needed centers
Total number of facilities
Facility type (dummy variable)
County (there are other categories)
Private
Bureau of Prisons (federal)
Guaranteed minimum (dummy variable)
Additional variables:
Border
Southern border (1,0)
Northern border (1,0)